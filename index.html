<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="http://fonts.googleapis.com/css?family=Trocchi" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Trykker" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
<link rel="stylesheet" type="text/css" href="/css/archive.css" />
<link rel="shortcut icon" href="/favico.ico" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
<title>Revolution blahg 
</title>
</head>
<body>
<div id="container">
  <div id="header">
    <h1><a href="/" class="title">Revolution blahg</a></h1>
    <a href="/">home</a>
    <a href="/archive">archive</a>
    <a href="/about">about</a>
  </div>
<div id="sidebar">
<div id="recent">
<h4>Recent</h4>
<ul>
  <li><a href="http://mapleoin.eu/perma/mocking-python-file-open">Mocking python's file open() builtin</a></li>
  <li><a href="http://mapleoin.eu/perma/FOSDEM-2012-review">FOSDEM 2012 review</a></li>
  <li><a href="http://mapleoin.eu/perma/data-visualizations">Data Visualizations</a></li>
  <li><a href="http://mapleoin.eu/perma/sql-and-relational-theory-master">SQL and Relation Theory Master Class</a></li>
  <li><a href="http://mapleoin.eu/perma/copr-final-report">Copr final report</a></li>
</ul>
</div><!--recent-->
<br />
<div id="tags">
<h4>Tags</h4>
<ul>
  <li><a href="/tag/gsoc.html">gsoc</a></li>
  <li><a href="/tag/packaging.html">packaging</a></li>
  <li><a href="/tag/fedora.html">fedora</a></li>
  <li><a href="/tag/python.html">python</a></li>
  <li><a href="/tag/unix.html">unix</a></li>
  <li><a href="/tag/linux.html">linux</a></li>
  <li><a href="/tag/programming.html">programming</a></li>
  <li><a href="/tag/floss.html">floss</a></li>
  <li><a href="/tag/django.html">django</a></li>
  <li><a href="/tag/copr.html">copr</a></li>
  <li><a href="/tag/fedora-summer-coding.html">fedora-summer-coding</a></li>
  <li><a href="/tag/books.html">books</a></li>
  <li><a href="/tag/emacs.html">emacs</a></li>
  <li><a href="/tag/freebsd.html">freebsd</a></li>
  <li><a href="/tag/databases.html">databases</a></li>
  <li><a href="/tag/creativecommons.html">creativecommons</a></li>
  <li><a href="/tag/music.html">music</a></li>
  <li><a href="/tag/hacking.html">hacking</a></li>
  <li><a href="/tag/foss.html">foss</a></li>
  <li><a href="/tag/fedora-ro.html">fedora-ro</a></li>
  <li><a href="/tag/events.html">events</a></li>
</ul>
</div><!--tags-->
</div><!--sidebar-->
<div id="content">
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/mocking-python-file-open">Mocking python's file open() builtin</a></h2>
        <h3>Thursday, November 15, 2012</h3>
        <div class="entry">
            	<p>I was working on a method to read some proxy information from several files today and then I wanted to test it.</p>

	<p>A <em>very</em> simplified version (the original has all the different files being processed in different functions on different rules and it actually has error handling) of this function is this:</p>

<div class="Python"><div class="highlight"><pre><span class="n">SYS_PROXY</span> <span class="o">=</span> <span class="s">&#39;/etc/sysconfig/proxy&#39;</span>
<span class="n">CURL_PROXY</span> <span class="o">=</span> <span class="s">&#39;/root/.curlrc&#39;</span>
<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;http_proxy&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;http_proxy = &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proxy</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;--proxy&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;--proxy &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proxy</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;http_proxy&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>As unit tests should be self-contained, they shouldn&#8217;t read any files on disk. So we need to mock them. I generally use Michael Foord&#8217;s <a href="http://www.voidspace.org.uk/python/mock/">mock</a>.</p>

	<p>In order to intercept calls to python&#8217;s <a href="http://docs.python.org/2/library/functions.html#open">open()</a>, we need to mock the <code>builtins.open</code> function:</p>

<div class="Python"><div class="highlight"><pre><span class="n">TEST_PROXY</span> <span class="o">=</span> <span class="s">&#39;http://example.com:1111&#39;</span>
<span class="k">def</span> <span class="nf">test_proxy_url_in_sysproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&quot;builtins.open&quot;</span><span class="p">,</span>
                    <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&quot;http_proxy = &quot;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>We&#8217;re good so far. Now we add the next natural test: we didn&#8217;t find anything in sysconfig, but we find the right proxy <span class="caps">URL</span> on our second try in CURL_PROXY:</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&quot;builtins.open&quot;</span><span class="p">,</span>
                        <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>Urgh. That&#8217;s starting to look a bit clunky. It&#8217;s also wrong since the inner <code>with statement</code> ends up overriding the outer one and all we get for our second <code>open()</code> call is a <i>closed</i> file object:</p>

<pre>ValueError: I/O operation on closed file.
</pre>

	<p>Not to worry though. <code>mock</code> <a href="http://www.voidspace.org.uk/python/mock/mock.html#mock.Mock.side_effect">side_effect</a> have got us covered!</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&quot;builtins.open&quot;</span><span class="p">,</span>
                    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(),</span>
                                 <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>The code looks cleaner now. A bit. And at least it works. But the list we pass in to <code>side_effect</code> makes another issue pop up. We now seem to be dependent on the order that the files are opened and read. That seems clunky. If we had to refactor our code to change the order that we read files in <code>get_proxy()</code> we would also had to change all our tests. Also it&#8217;s not quite obvious why we&#8217;re setting our return values as side effects.</p>

	<p>Ideally we&#8217;d have a way to assign each result to a filename and then not have to care about the order in which the files are open. In real life we would have two files with different contents anyway.</p>

	<p>So let&#8217;s implement that method. We, of course, want to make it a context manager.</p>

<div class="Python"><div class="highlight"><pre><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">):</span>
        <span class="k">yield</span>
</pre></div>
</div>

	<p>So we only intercept the filename that we want to mock and let everything else pass through to <code>builtins.open()</code>. The <code>yield</code> is there because a contextmanager should be a generator function. Everything before the <code>yield</code> gets executed when entering the <code>with mock_open ...</code> statement, then the content of the <code>with</code> block is executed and then everything after the <code>yield</code> in our mock_open function (there&#8217;s nothing there in our case).</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>Looks good.</p>

<pre>RuntimeError: maximum recursion depth exceeded in comparison
</pre>

	<p>Oops. It seems that we got into infinite recursion because we&#8217;re calling the mocked <code>open()</code> from the mocking function. We have to make sure that once we&#8217;ve mocked a call to <code>open()</code>, there&#8217;s no way we&#8217;re going to go through that mock again. Thankfully, the mock library provides methods to turn mocking on and off without using the <code>with mock.patch</code> context manager. Take a look at <code>mock.patch</code>&#8217;s <a href="http://www.voidspace.org.uk/python/mock/patch.html#patch-methods-start-and-stop">start and stop methods</a>.</p>

<div class="Python"><div class="highlight"><pre><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">open_file</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>

	<p>So we had to replace the <code>with mock.patch</code> statement with manually <code>start()</code>-ing and <code>stop()</code>-ing the mocking functionality before and after the <code>yield</code>. That&#8217;s basically what the <code>with</code> statement was doing, we just needed the indentifier so we can use it in the <code>else</code> branch.</p>

	<p>In the <code>else</code> branch we turn off the mocking before calling <code>open()</code> (that&#8217;s what was causing us to go in the infinite loop). After we&#8217;ve called <code>open()</code>, we go back to mocking <code>open()</code>, in case there will be a future call that we actually do want to mock.</p>

	<p>Test code now looks the same as before:</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>But this time it works. So we could all go home now.</p>

	<p>But say we wanted to ensure that no files were opened inside the <code>with mock_open</code> block other than the ones we mocked. It seems like a pretty sensible thing to do. Unit tests should be completely self-contained so you want to ensure they won&#8217;t be opening any files on the system. This would also catch some bugs that might only later pop-up on your CI server&#8217;s test runs, because of a custom development machine configuration.</p>

	<p>The problem is pretty simple if you use only one <code>with mock_open</code> block, but once you start using more than one nested contest managers you have a problem. You need to have a way to communicate between the different context-managers. Ideally you&#8217;d have a way for each context-manager to say to the others (after it&#8217;s finished processing): <em>hey, I finished my work here, but some dude opened a file which I didn&#8217;t mock. Did you mock it?</em>.</p>

	<p>So how do we solve that? We&#8217;ll use <code>global</code> variables! No. Just kidding.</p>

	<p>We&#8217;ll use exceptions. Simply make the inner statement raise a custom <code>NotMocked</code> exception and let the enclosing context managers catch.If none of the enclosing context managers mock the file that was opened in the inner block, they just let the user deal with the exception.</p>

	<p>So the exception can be a normal <code>Exception</code> subclass, but we need an extra bit of information, the <code>filename</code> that wasn&#8217;t mocked. I&#8217;ll also hardcode an error message in there:</p>

<div class="Python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NotMocked</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NotMocked</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="s">&quot;The file </span><span class="si">%s</span><span class="s"> was opened, but not mocked.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</pre></div>
</div>

	<p>The updated <code>mock_open</code> code looks like this:</p>

<div class="Python"><div class="highlight"><pre><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">open_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">open_file</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
</pre></div>
</div>

	<p>So we&#8217;re recording all the files that were opened in the <code>open_files</code> list. Then after all the code inside the <code>with</code> block was executed, we go through the <code>open_files</code> list and raise a <code>NotMocked</code> exception for each of those file names. We also added a new <code>complain</code> parameter just in case someone would like to turn this functionality off (maybe they want to use file fixtures after all).</p>

	<p>The StringIO objects now also have a <code>name</code> attribute. It&#8217;s a bit tricky to see why this is needed since at first sight those objects never get into the open_files list. But when we have nested <code>with mock_open</code> blocks the file returned by the <code>open()</code> function in <code>mock_file</code> might actually have been mocked by an enclosing context manager and its type would then be <code>StringIO</code>.</p>

	<p>The <code>try: except:</code> block around <code>yield</code> is for the enclosing context managers. When they get a <code>NotMocked</code> exception by running the code inside them, they check if it&#8217;s the file they&#8217;re mocking, in which case they ignore it. (Basically telling the nested context manager: <em>I&#8217;ve got you covered.</em>). If the <code>NotMocked</code> exception was raised on a file that&#8217;s different than the one they&#8217;re mocking, they simply re-raise it for someone else to deal with (either an enclosing context-manager) or the user.</p>

	<p>If we now added another <code>open()</code> call in our initial <code>get_proxy()</code> function, or inside the with statement in the test case,</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
            <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>we&#8217;d get this error:</p>

<pre>NotMocked: The file /dev/null was opened, but not mocked.
</pre>

	<p>Cool. Now how about the opposite? I had to refactor a lot of these test cases and at some point I wasn&#8217;t sure that all those assertions made sense. Was I really hitting all the files I had mocked? Well we could just add another check in our <code>mock_open()</code> code to see if all the files that were mocked, were actually accessed
 by the test code:</p>

<div class="Python"><div class="highlight"><pre><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;The file </span><span class="si">%s</span><span class="s"> was not opened.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</pre></div>
</div>

	<p>We now track mocked files as <code>open_files</code>, too. Then at the end, we simply check if the file that we were supposed to be mocking (passed in as the <code>filename</code> argument) was indeed opened.</p>

	<p>The gotcha here is that we need to raise this exception before <code>NotMocked</code>, otherwise we risk the code not ever getting to the file-not-opened check. I guess this is where the difference between using exceptions when something exceptional occured vs. when you want to communicate with the enclosing function becomes obvious.</p>

	<p>If we now added another <code>mock_open</code> that we weren&#8217;t using to the test code:</p>

<div class="Python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">):</span>
                <span class="n">get_proxy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>We&#8217;d get:</p>

<pre>AssertionError: The file /dev/null was not opened.
</pre>

	<p>EDIT: Eric Moyer found a bug (and suggested a fix) in this implementation. When the same file is opened multiple times, the <code>open_files</code> list will contain the filename multiple times, but it will only get <code>remove</code>-ed once. This can be easily solved by making the <code>open_files</code> list a set instead.</p>

	<p>So that&#8217;s about it, we now have a rock-solid <code>mock_open</code> function for mocking the builtin <code>open()</code>.</p>

	<p>Before we set it free, we need to add a nice docstring to it:</p>

<div class="Python"><div class="highlight"><pre><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock the open() builtin function on a specific filename</span>
<span class="sd">.</span>
<span class="sd">    Let execution pass through to open() on files different than</span>
<span class="sd">    :filename:. Return a StringIO with :contents: if the file was</span>
<span class="sd">    matched. If the :contents: parameter is not given or if it is None,</span>
<span class="sd">    a StringIO instance simulating an empty file is returned.</span>
<span class="sd">.</span>
<span class="sd">    If :complain: is True (default), will raise an AssertionError if</span>
<span class="sd">    :filename: was not opened in the enclosed block. A NotMocked</span>
<span class="sd">    exception will be raised if open() was called with a file that was</span>
<span class="sd">    not mocked by mock_open.</span>
<span class="sd">.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;The file </span><span class="si">%s</span><span class="s"> was not opened.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</pre></div>
</div>
        </div>
        <div class="post_tags">Tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/python.html">python</a>
        </div>
        <a href="http://mapleoin.eu/perma/mocking-python-file-open#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/FOSDEM-2012-review">FOSDEM 2012 review</a></h2>
        <h3>Wednesday, February 15, 2012</h3>
        <div class="entry">
            	<p>I went to <a href="http://fosdem.org">FOSDEM</a> this year. Thanks <a href="http://suse.com">SUSE</a> for sponsoring my trip! Here is a short review for the projects that I found interesting at this year&#8217;s <span class="caps">FOSDEM</span>.</p>

	<h4><span class="caps">SATURDAY</span></h4>

	<h4><a href="http://aeolusproject.org/">The Aeolus Project</a></h4>

	<h5>Francesco Vollero &#8211; Red Hat</h5>

	<p>This is a very interesting project if you can go past how <em>meta</em> it is.  It wants to be an abstraction over all the existing private and public cloud solutions. The aim of the project is to be able to create and control a virtual system throughout its life cycle. It can be converted from one VM image format to another and be deployed/moved from one cloud provider to another. Groups of images can be setup and controlled together. The way resources are managed and billed would also be cloud-independent.</p>

	<p>It relies heavily on the DeltaCloud project.</p>

	<h4>Open Clouds with <a href="http://deltacloud.apache.org/">DeltaCloud</a></h4>

	<h5>Michal Fojtik &#8211; Red Hat</h5>

	<p>DeltaCloud aims to be a RESTful <span class="caps">API</span> that is able to abstract all of the other public or private cloud APIs, allowing for the development of cloud-independent software.  The project says it wants to be truly independent (esp. from Red Hat). It was accepted as a top-level Apache project.</p>

	<h4><span class="caps">DMTF</span> <span class="caps">CIMI</span> and Apache DeltaCloud</h4>

	<h5>Marios Andreou &#8211; Red Hat</h5>

	<p>The <span class="caps">CIMI</span> <span class="caps">API</span> is a specification for interacting with various cloud-resources. A lot of very big companies are part of the <span class="caps">DMTF</span> Cloud Management Working Group: Red Hat, VMware Inc., Oracle, <span class="caps">IBM</span>, Microsoft Corporation, Huawei, Fujitsu, Dell. It is currently being implemented as part of the DeltaCloud <span class="caps">API</span>. The presenter also showed some implementation details: a lot of the code is shared between the DeltaCloud and the <span class="caps">CIMI</span> <span class="caps">API</span>.</p>

	<h4>Infrastructure as an opensource project</h4>

	<h5>Ryan Lane &#8211; Wikimedia Foundation</h5>

	<p>The talk went into some detail about the whole Wikimedia setup. It is built on top of open source projects and aims to be entirely free and available to anyone who wants to know more about it. The speaker presented some of the issues that the Wikimedia organization faced when they decided to give full root access to their machines to volunteers and how to allow for different levels of trust.</p>

	<h4>Orchestration for the cloud &#8211; <a href="https://juju.ubuntu.com/">Juju</a></h4>

	<h5>Dave Walker &#8211; Canonical</h5>

	<p>Juju is a system for building recipes of configurations and packages that can then be deployed on openstack/EC2 systems. The project aims to integrate with tools like chef and puppet to be able to manage deploying, connecting, configuring and running suites of applications in the cloud.</p>

	<h4>OpenStack developers meeting</h4>

	<p>This was a rather informal discussion. 4 major distros were present: Fedora, Ubuntu, <span class="caps">SUSE</span> and Debian, but also some other contributors. Upstream asked about the problems that distributions face, some minor one-time occurrences were discussed briefly. Stefano Maffulli, the openstack community manager was also present and there were some heated discussions about the way the project is governed. There are still a lot of things being discussed behind closed doors. Negotiations about the future of the project and fund-gathering is done with only a few big companies at a very high level. The community, on the other hand, was very vocal about wanting to rule itself with no enterprise interference.</p>

	<h4>Rethinking system and distro development</h4>

	<h5>Lars Wirzenius</h5>

	<p>Advanced the idea of maintaining groups of packages, all locked at a specific version. Having the maintainers always know which combination of versions a bug comes from would make the whole environment easier to replicate and the bug easier to reproduce. This would also, supposedly, reduce some of the complexities of dealing with dependencies.</p>

	<p>These groups of packages would be built directly from the upstream&#8217;s sources, following rules laid out in a git repository. The speaker also said he wants to get rid of binary packages completely.</p>

	<p>If this were to be implemented, distributions could write functional tests against whole systems (continuously built images), rather than individual binary packages and ensure that a full configuration works.</p>

	<p>Someone from the audience mentioned that a lot of the ideas in the talk are already implemented in NixOS(nixos.org) (which looks like a very interesting project in itself).</p>

	<h4><span class="caps">SUNDAY</span></h4>

	<h4>Continuos Integration/ Continuos Delivery</h4>

	<h5>Karanbir Singh &#8211; CentOS</h5>

	<p>The speaker discussed the system which CentOS uses for continuous integration. I liked their laissez-faire approach to which type of functional test language they should be using. They basically allow any type of language/environment to be used when running tests. The only requirement is that the test returns 0 on success and something else on failure. Anyone can write functional tests in any language they want (they just specify the packages as requirements for their test environment). People can choose to maintain different groups of packages along with the tests associated to them.</p>

	<h4>The Apache <a href="http://cassandra.apache.org">Cassandra</a> Storage Engine</h4>

	<h5>Sylvain Lebresne</h5>

	<p>A lot of interesting concepts about the optimizations that were made in the Cassandra project in order to speed up writes and make reads twice as fast (almost as fast as reads): different levels of caching, queuing writes, merge sorting the read cache with the physical data on reads etc.</p>

	<h4><a href="http://freedomboxfoundation.org/">Freedom, Out of the Box!</a></h4>

	<h5>Bdale Garbee</h5>

	<p>An interesting project about making a truly free easily available software as well as hardware system. Some interesting concepts are used in this project like <span class="caps">GPG</span> keys for authentication, but also for the trust required to provide a truly decentralized peer based network, free from DNSes.</p>

<hr/>

	<p>I&#8217;ve been to a few other talks that I can&#8217;t remember anything from either because of the bad quality of the presentation or because I didn&#8217;t have the prerequisite knowledge to understand what they were talking about. Next time I should also take notes.</p>

	<p>A lot of the talks were recorded and are available over here (with more coming): <a href="http://video.fosdem.org/2012/"><span class="caps">FOSDEM</span> 2012 videos</a>. The quality of the recordings (esp. in the main room) is sometimes even better than being there live. The voice is clearer and there is no ambient noise. Also, as it was really cold in most of the rooms &#8211; I had to keep my jacket and hat on.</p>
        </div>
        <div class="post_tags">Tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/databases.html">databases</a>
                <a href="/tag/foss.html">foss</a>
                <a href="/tag/fedora.html">fedora</a>
        </div>
        <a href="http://mapleoin.eu/perma/FOSDEM-2012-review#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/data-visualizations">Data Visualizations</a></h2>
        <h3>Friday, October 28, 2011</h3>
        <div class="entry">
            	<p><img src="&gt;http://covers.oreilly.com/images/9781449312282/s.gif" alt="" /> This book is a short introduction to Data Visualization. Everything you would expect (and which you probably already know) is in there: bar graphs, histograms, diagrams; use of color, shape, size, positioning, info graphics and youtube videos of Bruce Lee. I got this book because I was starting to work on a project which required generating a lot of graphs. However, I&#8217;m not sure that there was any new and helpful information to help me in my project contained in this book. In fact this was my biggest problem with this book: I wasn&#8217;t sure that I was in the audience for it.</p>

	<p>There were two opposite take-aways. The first one was: there are some basic common-sense rules which you need to keep in mind when designing data visualizations (and which you probably already know from your Statistics 101 course). And the second one was: Data Visualization is really an art and it is a huge domain with a lot of possibilities, so if you want to design any advanced data visualization you&#8217;d better leave it to a professional.</p>

	<p>The book is however very well structured and the quality of the content is very high while entirely theoretical; it won&#8217;t try to tell you what to draw and when; just what a data visualization is, what they usually look like, what they look like when they&#8217;re bad and what they look like when they&#8217;re really good. Some interesting points are raised and explained; for example the fact that color can not be ordered. I think it would be a good high-school level introduction to data visualization and it has a lot of links which might prove useful to someone who would want to go deeper in this topic. On the other hand this book doesn&#8217;t do much on it&#8217;s own.</p>

	<p>Although this book is available in all the usual ebook formats (<span class="caps">PDF</span>, mobi and epub), it has a lot of really big and colourful graphics which don&#8217;t really fit well on an ereader. The authors themselves suggest to look at them on your computer (which means that even though you can read the book on your ereader, you should stay close to a computer in order to comprehend the visualizations.</p>
        </div>
        <a href="http://mapleoin.eu/perma/data-visualizations#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/sql-and-relational-theory-master">SQL and Relation Theory Master Class</a></h2>
        <h3>Monday, September 26, 2011</h3>
        <div class="entry">
            	<p><a href="http://oreilly.com/catalog/0636920010005/" class="img"><img src="&gt;http://covers.oreilly.com/images/0636920010005/s.gif" alt="" /></a> This video course is perhaps the best way to meet the famous C. J. Date and his astonishingly comprehensive style. The lectures are a great introduction to database theory while at the same time they lay a very solid foundation for any database practitioners or theorists. The author introduces some very useful theoretical notions that are essential to grasping the more subtle concepts of database design and he does so in a high-class fashion.</p>

	<p>C. J. Date&#8217;s style of explaining and teaching, which can also be seen in his books, is didactic and very thorough while at the same time astonishingly clear. Many times while reading the book that these videos are based on and even afterward while watching the videos, I had to stop in order to reflect at the great volume of information that I had absorbed in a surprisingly simple manner. These videos are full of very deep notions about databases and can really benefit from reviewing at a later time, just to cement the knowledge or reflect on certain topics which come up during everyday practice.</p>

	<p>C. J. Date sets out to demolish <span class="caps">SQL</span> as a language fit for relational theory and databases in general. While going through all the database theory concepts he presents the ideal case and an ideal query language (actually not ideal, but as he demonstrates, the correct ones) contrasting them to generic <span class="caps">SQL</span>. He also posits and sets out to prove, in a very interesting argument, that relational databases are the only way to store data and all other data models <strong>will not endure</strong>. </p>

	<p>These are the days of <span class="caps">NOSQL</span> databases, but I think that the information contained in these lectures will be useful for a lot more time and in a lot more settings than just conventional <span class="caps">SQL</span> databases that are used in the majority of current systems. I oftentimes find myself thinking in relational terms even while designing the redis data model that I&#8217;m currently working on.</p>

	<p>The only problem I have is that I sometimes felt that the lectures were a bit dull. It is also possible that I got this impression because I was watching too many without interruption :). While the content of the lectures is excellent, the presentation could be improved. Often times I felt that the audience present in the classroom could have done more to improve the dynamism of the lectures. It seemed that the only reason why they were there was so that the presenter wouldn&#8217;t feel alone. I would have enjoyed more challenging questions and especially some skeptical comments from industry veterans perhaps. I&#8217;m sure those would have led to very interesting debates considering the high class of the lecturer and presumably, the attendants.</p>
        </div>
        <div class="post_tags">Tags:
                <a href="/tag/foss.html">foss</a>
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/databases.html">databases</a>
                <a href="/tag/books.html">books</a>
        </div>
        <a href="http://mapleoin.eu/perma/sql-and-relational-theory-master#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/copr-final-report">Copr final report</a></h2>
        <h3>Tuesday, September 28, 2010</h3>
        <div class="entry">
            	<p><a href="https://fedoraproject.org/wiki/Summer_Coding_2010">Fedora Summer Coding</a> is now over for me and I&#8217;m really glad of what I learned and coded this summer.</p>

	<p>Our initial goal was to develop a TurboGears2 Web app and <span class="caps">JSON</span> <span class="caps">API</span> for <a href="https://fedoraproject.org/wiki/Category:Copr">Fedora Copr</a>. When finished, Copr should provide everyone with a place to build Fedora packages and host custom repositories for everyone to enjoy. This is a project that should prove quite popular in the Fedora Community when it gets released and I&#8217;m glad to have played a role in its development.</p>

	<p>At first I worked on the web app, modeling the database and the relationship between coprs and repos and packages and then developing the <span class="caps">JSON</span> <span class="caps">API</span>. When the midterm came, my mentor and I decided that I should also contribute to the other parts of Copr. The original schedule had a simple command-line client planned, but we went further than that. In the end all of the functionality of the <span class="caps">JSON</span> <span class="caps">API</span> also got implemented in a client library (based on and very similar to <a href="https://fedorahosted.org/python-fedora/">python-fedora</a>) and in a command-line client. I also got to dive into python-fedora&#8217;s and repoze.who&#8217;s internals in order to get basic <span class="caps">HTTP</span> authentication working for TurboGears2.</p>

	<p>My latest work has been on the <a href="https://fedorahosted.org/func/">func</a> module. This is the buildsystem part of Copr. Func minions running this module will be commanded by <a href="https://fedorahosted.org/headhunter">headhunter</a> (Copr&#8217;s scheduler) to build packages in mock and then move them into repositories. The module also creates, updates and deletes package repositories and will check the built packages for Fedora conformance (e.g. licensing) &#8211; this last part is not yet implemented. I got to play with virtual machines and func and <a href="https://fedoraproject.org/wiki/Projects/Mock">mock</a> and <a href="http://createrepo.baseurl.org/">createrepo</a>.</p>

	<p>There is a more synthethic overview of all the different things that got implemented <a href="https://fedoraproject.org/wiki/User:Mapleoin/FSC-Copr-status">on the wiki</a>.</p>

	<p>Overall, I&#8217;m really glad of what I learned this summer. This project really got me involved in a lot of different levels of the architecture of a web service and a lot of different technologies. Some of the things I worked on looked really scary at first, but as I went nearer and read more code the mist slowly vanished.</p>

	<p>My mentor, <a href="http://anonbadger.wordpress.com/">Toshio Kuratomi</a> was great as always. This isn&#8217;t the first project I&#8217;ve had him as my mentor. He was always there to talk to and always had great answers to all of my questions. He had great patience in answering and explaining anything I asked about. Our discussions were mostly about the architecture of the app we were building, but he also gave me great tips on the inner workings of python-fedora or on deploying the web app. I felt I had a lot of liberty to decide the way things will get implemented. Regardless of whether we will ever work together again, Toshio will always be a great inspiration for me as a programmer and as a person.</p>
        </div>
        <div class="post_tags">Tags:
                <a href="/tag/fedora.html">fedora</a>
                <a href="/tag/copr.html">copr</a>
                <a href="/tag/fedora-summer-coding.html">fedora-summer-coding</a>
                <a href="/tag/foss.html">foss</a>
        </div>
        <a href="http://mapleoin.eu/perma/copr-final-report#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/moving-on-to-the-buildsystem">FSC: moving to the buildsystem</a></h2>
        <h3>Monday, September  6, 2010</h3>
        <div class="entry">
            	<p>I started working on the buildsystem part of copr this week. Right now, I&#8217;m still getting familiar with <a href="http://fedorahosted.org/func">func</a>. That&#8217;s what we&#8217;ll be using to communicate with the builder machines: get them running errands and get back status reports at any time. I spent a lot of time getting a virtual machine setup with libvirt; networking especially was a pain (mostly because of my pppoe connection I think).</p>

	<p>One nice feature of func that I think we&#8217;ll be using a lot is the <a href="https://fedorahosted.org/func/wiki/AsyncUsage">async mode</a>. A mock build takes a lot of time, what with all the yumming and compiling. So starting a task via one of the user interfaces and then choosing whether or not to keep watching it and what to watch for will probably be an essential part of the buildsystem&#8217;s functionality.</p>

	<p>In the meantime, we&#8217;re slowly <a href="https://fedorahosted.org/fedora-infrastructure/ticket/2339">getting resources</a> for the deployment of Copr. Toshio got a running instance of the current state of the TG app on <a href="http://publictest1.fedoraproject.org/copr/">publictest1</a>. It looks just like a quickstarted TG app, because it doesn&#8217;t have any WebUI. But it can <span class="caps">CRUD</span> coprs, handle dependencies between them, handle permissions and <span class="caps">CRD</span> packages. Most of the functions require a <a href="http://admin.fedoraproject.org/accounts">FAS</a> account, but you don&#8217;t need one to see a <a href="http://publictest1.fedoraproject.org/copr/coprs.json">list of all the coprs</a>, or a <a href="http://publictest1.fedoraproject.org/copr/firstcopr/packages.json">list of packages in a copr</a>.</p>
        </div>
        <div class="post_tags">Tags:
                <a href="/tag/copr.html">copr</a>
                <a href="/tag/fedora-summer-coding.html">fedora-summer-coding</a>
                <a href="/tag/foss.html">foss</a>
        </div>
        <a href="http://mapleoin.eu/perma/moving-on-to-the-buildsystem#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
    <div class="post">
        <h2><a href="http://mapleoin.eu/perma/copr-client-part-2">the Copr client part II</a></h2>
        <h3>Monday, August 30, 2010</h3>
        <div class="entry">
            	<p>I spent this week finishing up the copr client. It now supports all the functionality that the Copr TG <span class="caps">API</span> supports. It&#8217;s not much, but it&#8217;s a starting point.</p>

	<p>I spent a lot of time trying to understand the way repoze.who works and the authentication plugins that we&#8217;re using for the <a href="https://fedorahosted.org/python-fedora/">python-fedora</a> <a href="https://admin.fedoraproject.org/accounts">FAS</a> authentication plugin. I finally understood it, I think&#8230; The Fedora client library didn&#8217;t support basic <span class="caps">HTTP</span> Authentication for TG2 apps so I had to figure out how to integrate that into our authentication plugin. It was quite fun all in all, repoze.who has a very interesting way of doing authentication and writing wsgi middleware is always exciting ;). This patch will hopefully go upstream to python-fedora now.</p>

	<p>This next week I&#8217;ll probably start working on the buildsystem part of Copr. There are a lot of new things to learn there.</p>


        </div>
        <div class="post_tags">Tags:
                <a href="/tag/copr.html">copr</a>
                <a href="/tag/fedora-summer-coding.html">fedora-summer-coding</a>
                <a href="/tag/foss.html">foss</a>
        </div>
        <a href="http://mapleoin.eu/perma/copr-client-part-2#disqus_thread" class="comments">Comments</a>
        <img class="separator" alt="post separator" src="/css/separator.png" />
    </div>
</div>
<div style="clear: right;"></div>
</div><!-- container -->
<div id="smallprint"><a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.</div>

<script type="text/javascript">
var disqus_shortname = 'revolutionblahg';
(function () {
  var s = document.createElement('script'); s.async = true;
  s.src = 'http://disqus.com/forums/revolutionblahg/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-5576939-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
